#--------------------------------------#
## Project: vera4cast PE
## Script purpose: Calculates text-specific statistics/analyses for the manuscript
## Date: 2025-02-23
## Author: Cayelan Carey
#--------------------------------------#

library(tidyr)

# make it consistent across reservoirs
start_date <- targets_P1D_interp |> 
  reframe(.by = c(variable, depth_m, site_id), 
          start = min(date, na.rm = T)) |> 
  reframe(last_start = max(start)) |> 
  pull(last_start)

#Methods site description
BVRdepth <- read.csv(bvre_EDI) |> 
  filter(DateTime>start_date) |> 
  select(DateTime, LvlDepth_m_13) |> 
  drop_na() |> 
  summarise(BVRmax_depth = max(LvlDepth_m_13))

FCRdepth <- read.csv(fcre_EDI) |> 
  filter(DateTime>start_date) |> 
  select(DateTime, LvlDepth_m_9) |> 
  drop_na() |> 
  summarise(FCRmax_depth = max(LvlDepth_m_9))

#Results paragraph 1
anoxia_cal <- targets_P1D |>
  filter(date>start_date,
         variable=="DO_mgL") |> 
  group_by(site_id) |> 
  count(observation<=2)
#gives number of days that meet 2 mg/L DO anoxia criteria in both reservoirs

#Results paragraph 1
spcond_median <- targets_P1D |> 
  filter(date>start_date,
         variable=="SpCond_uScm") |>
  group_by(site_id) |> 
  drop_na() |> 
  summarise(medSC = median(observation))
#gives median specific conductance in FCR vs. BVR

#Results paragraph 1
fdom_avg <- targets_P1D |> 
  filter(date>start_date,
         variable=="fDOM_QSU") |>
  group_by(site_id) |> 
  drop_na() |> 
  summarise(fdom_avg = mean(observation))

chla_avg <- targets_P1D |> 
  filter(date>start_date,
         variable=="Chla_ugL") |>
  group_by(site_id) |> 
  drop_na() |> 
  summarise(chla_avg = mean(observation))
#gives mean fDOM and chla concentrations in BVR vs FCR

#Results paragraph 2
#need to get whole-period PE for all variables
sort(1-summary_PE$PE)
#gives range of minimum and maximum PE

#Results paragraph X
depth_analysis_DO <- PE_ts_P1D |> 
  filter(date>start_date,
         variable=="DO_mgL",
         depth_m=="bottom") |> 
  group_by(site_id) |> 
  drop_na() |> 
  mutate(PE_1=1-PE) |> 
  count(PE_1>0.5)
#how many bottom DO 1-PE values are >0.5?

depth_analysis_Tw <- PE_ts_P1D |> 
  filter(date>start_date,
         variable=="Tw_C",
         depth_m=="bottom") |> 
  group_by(site_id) |> 
  drop_na() |> 
  mutate(PE_1=1-PE) |> 
  count(PE_1>0.5)
#how many bottom water temp 1-PE values are >0.5?


# duration of ice cover
infile <- "https://pasta.lternet.edu/package/data/eml/edi/456/5/ebfaad16975326a7b874a21beb50c151" 

ice_continuous <- get_ice_continuous(infile)

# how many days of ice cover per winter?
# offset the year by 6 months to get continuous winters June-June
ice_continuous |> 
  dplyr::filter(year(Date) %in% c(2021, 2022, 2023, 2024)) |>
  mutate(ice_year = year(Date - days(6*30))) |> 
  dplyr::filter(IceOn == 1) |> 
  reframe(.by = c(Reservoir, ice_year),
          ice_days = n_distinct(Date), 
          earliest = min(Date),
          latest = max(Date))
  
